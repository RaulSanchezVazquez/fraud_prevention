#!/usr/bin/env python3# -*- coding: utf-8 -*-import pandas as pdfrom sklearn.model_selection import train_test_splitfrom fraud_prevention import configfrom fraud_prevention.features import feature_utilsfrom fraud_prevention.features import creditcarddef balance_class(data, k_negative=1):    """    """    if k_negative is None:        return data    if k_negative is not None:        is_pos_class = data['Class'] == 1        data_pos = data[is_pos_class]        data_neg = data[~is_pos_class]        neg_sample_size = is_pos_class.sum() * k_negative        if neg_sample_size < data.shape[0]:            data_neg  = data_neg.sample(                neg_sample_size,                random_state=42)        data = pd.concat([            data_pos,            data_neg        ], axis=0)    return datadef remove_outliers(data, features):    """    """    # Remove outliers    is_f_outlier_cnt = []    for f in features:        min_val, max_val = data[f].quantile([            .01,            .99        ]).sort_index().tolist()        is_f_outlier = (            (                data[f] < min_val            ) | (                data[f] > max_val            )        ) & (            data['Class'] == 0        )        is_f_outlier_cnt.append(is_f_outlier)    is_f_outlier_cnt = pd.DataFrame(is_f_outlier_cnt).T.sum(axis=1)    is_not_outlier = (is_f_outlier_cnt == 0)    data = data[is_not_outlier]    return datadef get(val_size=.1, test_size=0.5, k_negative=10):    """Get the dataset.    Returns    --------    data : pandas.DataFrame        The data.    Examples    ---------    ::        import pandas as pd        from fraud_prevention.features import dataset        test_size = 0.5        val_size = .1        k_negative = 10        (            X_train, X_test, X_val,            y_train, y_test, y_val,            w_train, w_test, w_val        ) = dataset.get(            test_size=test_size,            val_size=val_size,            k_negative=k_negative)        pd.DataFrame([            {                "name": "train",                "size": X_train.shape[0],                "pos_class": (y_train == 1).sum(),                "new_class": (y_train == 0).sum()            },            {                "name": "val",                "size": X_val.shape[0],                "pos_class": (y_val == 1).sum(),                "new_class": (y_val == 0).sum()            },            {                "name": "test",                "size": X_test.shape[0],                "pos_class": (y_test == 1).sum(),                "new_class": (y_test == 0).sum()            },        ]).set_index('name')        Out[1]:                 size  pos_class  new_class        name        train    2435        218       2217        val       271         28        243        test   142404        246     142158    """    data = creditcard.get()    features = [        x        for x in data.columns        if x.startswith('V')    ] + ['Amount']    train_data, test_data = train_test_split(        data,        test_size=test_size,        random_state=42)    train_data, val_data = train_test_split(        train_data,        test_size=val_size,        random_state=42)    # Remove outliers from training    train_data = remove_outliers(        data=train_data,        features=features)    # Down sampling the negative class    if k_negative is not None:        train_data = balance_class(            data=train_data,            k_negative=k_negative)    # Features, target, and weights    X_train, y_train, w_train = \        train_data[features], train_data['Class'], train_data['Amount']    X_val, y_val, w_val = \        val_data[features], val_data['Class'], val_data['Amount']    X_test, y_test, w_test = \        test_data[features], test_data['Class'], test_data['Amount']    return (        X_train, X_test, X_val,        y_train, y_test, y_val,        w_train, w_test, w_val)